#!/usr/bin/env python -u
import argparse
from fabric.colors import yellow
from stevedore import driver, extension
from calyptos.rolebuilder import RoleBuilder
import os
import shutil

dot_dir = os.path.expanduser('~/.calyptos')
# by default we look in users home dir first
default_cfgfile = os.path.join(dot_dir, "config.yml")
cfglist = []
cfglist.append(default_cfgfile)
cfglist.append('/usr/share/calyptos/config.yml')

def locate_cfgfile():
    # if we find that the config file is in /usr/share
    # but the rpm is not installed, we copy it to ~/.calyptos
    # because that means calyptos was installed by setup.py
    for item in cfglist:
        if os.path.isfile(item):
            if item != default_cfgfile:
                import rpm # I think this is required by other parts of python so I'm safe using it
                ts = rpm.TransactionSet()
                mi = ts.dbMatch("name","calyptos")
                if (len(mi) == 0):
                    if not os.path.isfile(default_cfgfile):
                        if not os.path.exists(dot_dir):
                            try:
                                os.makedirs(dot_dir)
                            except OSError as e:
                                print('Error: cannot create directory ~/.calyptos: %s' % e)
                        try:
                            # if this copy works, return default_cfgfile
                            # because it will be used going forward
                            shutil.copy('/usr/share/calyptos/config.yml', default_cfgfile)
                            return default_cfgfile
                        except shutil.Error as e:
                            print('Error: %s' % e)
                        except IOError as e:
                            print('Error: %s' % e.strerror)
            # this is not in an else: block because its a
            # last resort for the case where import rpm
            # doesn't succeed above, because we still need
            # to return a valid config file name
            return item

if __name__ == '__main__':
    cfgfile = locate_cfgfile()
    parser = argparse.ArgumentParser()
    default_repo = 'https://github.com/eucalyptus/eucalyptus-cookbook'
    parser.add_argument('operation', choices=['validate',
                                              'prepare',
                                              'bootstrap',
                                              'provision',
                                              'debug',
                                              'uninstall'])
    parser.add_argument('-c', '--config', default=cfgfile)
    parser.add_argument('-e', '--environment', required=True)
    parser.add_argument('-p', '--password', default='foobar')
    parser.add_argument('-b', '--branch', default='euca-4.2')
    parser.add_argument('--cookbook-repo',
                        default=default_repo)
    parser.add_argument('-d', '--driver', default="chef")
    parser.add_argument('--debug', action='store_true', default=False)
    args = parser.parse_args()

    component_deployer = RoleBuilder(args.environment)
    if args.operation == 'validate':
        mgr = extension.ExtensionManager(
            namespace='calyptos.validator',
            invoke_args=(component_deployer,),
            invoke_on_load=True,
            propagate_map_exceptions=True
        )
        results = mgr.map_method(args.operation)
    elif args.operation == 'debug':
        mgr = extension.ExtensionManager(
            namespace='calyptos.debugger',
            invoke_args=(component_deployer,),
            invoke_on_load=True,
            propagate_map_exceptions=False
        )
        results = mgr.map_method(args.operation)
        total_failures = 0
        total_passed = 0
        for passed, failed in results:
            total_passed += passed
            total_failures += failed
        print yellow('Total passed: ' + str(total_passed))
        print yellow('Total failed: ' + str(total_failures))
        exit(total_failures)
    else:
        mgr = driver.DriverManager(
            namespace='calyptos.deployer',
            name=args.driver,
            invoke_on_load=True,
            invoke_args=(args.password,
                         args.environment,
                         args.config,
                         args.debug,
                         args.branch),
        )
        function = getattr(mgr.driver, args.operation)
        function()
